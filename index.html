<!DOCTYPE html>
<html>
<head>
<title data-i18n="title">Resistance Level Upgrade Calculator</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    /* Define CSS variables for consistent sizing */
    :root {
        --level-input-width: 45px; /* Enough for "Level" text + padding (max 2 digits) */
        --held-input-width: 130px; /* Comfortably fits "99,999,999,999" plus padding (16 chars) */
    }

    body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background-color: #f4f4f4;
        display: flex;
        flex-direction: column; /* Stack children (language selector, container, version) vertically */
        justify-content: flex-start; /* Align content from the top */
        align-items: center; /* Center items horizontally */
        min-height: 90vh;
    }
    .container {
        max-width: 550px;
        width: 100%;
        margin: 20px 0; /* Adjusted margin to allow space for language selector above */
        padding: 20px;
        border: 1px solid #ccc;
        border-radius: 8px;
        background-color: #fff;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    h2 {
        text-align: center;
        margin-top: 0;
        margin-bottom: 20px;
        line-height: 1.2;
    }
    .row {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
        flex-wrap: nowrap; /* Prevent wrapping on desktop by default */
    }
    /* Labels and display spans for general rows */
    .row .display-label,
    .row label {
        flex: 1; /* Labels take available space, can grow/shrink but prefer content size */
        margin-right: 15px; /* Controlled space between label and input */
        min-width: unset; /* Remove previous min-width that was causing large gaps */
        text-align: left; /* Align text to the left within its own space */
    }
    /* Inputs and select for general rows - NOW FIXED WIDTH on desktop */
    .row input[type="tel"],
    .row select {
        flex: 0 0 var(--held-input-width); /* Fixed width for consistency */
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
        text-align: right; /* Keep numbers aligned to the right */
        max-width: var(--held-input-width); /* Ensure it doesn't grow if flex: 1 was somehow applied */
    }
    /* Specific override for timezoneSelect - allow it to be wider */
    #timezoneSelect {
        flex: 1; /* Allows timezone select to take available space */
        max-width: unset; /* Override max-width to allow it to be wider than other inputs */
        width: 100%; /* Fill available space as it is flex:1 */
    }
    /* Display values for general rows - NOW FIXED WIDTH on desktop */
    .display-value {
        font-weight: bold;
        color: #333;
        flex: 0 0 var(--held-input-width); /* Fixed width for consistency */
        text-align: right; /* Ensure right justification */
        padding: 8px; /* Match input padding for alignment */
        min-width: unset; /* Remove previous min-width that was causing large gaps */
        box-sizing: border-box;
        max-width: var(--held-input-width); /* Apply same max-width for consistency */
    }


    /* Specific styling for building input rows to create columns */
    .building-row {
        display: grid;
        /* First column (labels) takes 'auto' space (content width), others use fixed widths */
        grid-template-columns: auto var(--level-input-width) var(--held-input-width);
        gap: 15px; /* Increased gap for better visual separation */
        align-items: center;
        margin-bottom: 8px;
    }
    .building-row label { /* Label for building names (e.g., Quartz Building 1) */
        grid-column: 1;
        text-align: left;
        margin-right: 0;
        min-width: unset;
    }
    /* Building input fields - now strictly adhere to defined widths */
    .building-row input[id^="level"] {
        grid-column: 2;
        width: 100%; /* Fill its grid cell */
        max-width: var(--level-input-width); /* Ensure it doesn't exceed its defined width */
        padding: 8px; /* Consistent padding */
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
        text-align: right;
    }
    .building-row input[id^="resource"] {
        grid-column: 3;
        width: 100%; /* Fill its grid cell */
        max-width: var(--held-input-width); /* Ensure it doesn't exceed its defined width */
        padding: 8px; /* Consistent padding */
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
        text-align: right;
    }

    button {
        width: 100%;
        padding: 10px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-top: 15px;
        font-size: 16px;
    }
    button:hover {
        background-color: #0056b3;
    }
    .header-row {
        font-weight: bold;
        margin-bottom: 5px;
        display: grid;
        /* Match building-row columns exactly */
        grid-template-columns: auto var(--level-input-width) var(--held-input-width);
        gap: 15px; /* Match building-row gap */
    }
    .header-row span:first-child { /* The empty span for layout */
        text-align: left;
        grid-column: 1;
    }
    .header-row strong { /* Changed labels to strong for header semantic */
        grid-column: auto;
        text-align: center;
    }
    hr {
        border: 0;
        height: 1px;
        background: #eee;
        margin: 15px 0;
    }

    /* --- Language Selector Container Styling --- */
    #language-selector-container {
        display: flex;
        align-items: center;
        gap: 5px;
        margin-top: 10px;
        margin-left: auto;
        margin-right: 20px;
        padding: 5px 0;
    }
    #language-selector-container label {
        margin: 0;
        flex: none;
    }
    #languageSelect {
        padding: 5px 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        background-color: #fff;
        cursor: pointer;
        min-width: 100px;
    }

    /* --- Version Info Styling --- */
    .version-info {
        margin-top: 20px;
        font-size: 0.8em;
        color: #777;
        text-align: center;
    }

    /* --- Media Queries for Mobile Responsiveness (max-width: 480px) --- */
    @media (max-width: 480px) {
        body {
            font-size: 15px; /* Reduced base font size for better mobile fit */
        }

        /* Language Selector Stacking */
        #language-selector-container {
            flex-direction: column; /* Stack label and dropdown vertically */
            align-items: flex-end; /* Keep aligned right if stacked */
            gap: 2px;
            margin-top: 10px;
            margin-right: 10px;
            padding: 0;
        }
        #language-selector-container label {
            font-size: 0.9em; /* Slightly larger for readability */
        }
        #languageSelect {
            padding: 5px 8px;
            font-size: 1em; /* Adjusted relative to new body font-size */
            min-width: unset; /* Allow it to shrink if needed */
        }

        /* Main Container */
        .container {
            max-width: 95%;
            margin: 10px auto;
            padding: 15px;
        }

        h2 {
            font-size: 1.3em; /* Slightly smaller for mobile */
            margin-bottom: 15px;
        }

        /* General rows on mobile (e.g., Resource Held) */
        .row {
            flex-wrap: nowrap; /* IMPORTANT: Prevent wrapping labels/inputs onto new line */
            justify-content: space-between; /* Space out label and input */
        }
        .row .display-label,
        .row label {
            flex: 0 1 auto; /* Allow label to shrink if needed (flex-shrink: 1), but prefer content size */
            min-width: 0; /* Allow content to shrink below its intrinsic width */
            margin-right: 10px; /* Keep a small gap */
            font-size: 1em; /* Adjust relative to new body font-size */
        }
        /* Inputs and display values for general rows on mobile */
        .row input[type="tel"],
        .display-value {
            flex: 1 1 auto; /* Allow input to fill remaining space, can shrink (flex-shrink: 1) */
            min-width: 0; /* Allow input to shrink below its intrinsic width */
            text-align: right !important; /* Force right justification on mobile */
            font-size: 1em; /* Adjust relative to new body font-size */
            max-width: 120px; /* Adjusted from 85px to better fit large numbers */
        }
        /* Specific overrides for timezoneSelect on mobile */
        #timezoneSelect {
            flex: 1; /* Takes available space */
            max-width: 100%; /* Ensure it doesn't overflow */
            width: 100%;
        }


        /* Building rows on mobile */
        .building-row {
            display: grid; /* Keep grid */
            /* Precise mobile column widths for strict alignment and consistent sizing */
            grid-template-columns: minmax(80px, 1fr) 40px 120px; /* Adjusted last column from 85px to 120px */
            gap: 8px; /* Slightly reduced gap on mobile */
            align-items: center; /* Ensure vertical alignment */
        }
        /* Make inputs fill their grid columns on mobile and remove desktop max-width */
        .building-row input[id^="level"] {
            width: 100%;
            max-width: unset; /* Remove desktop fixed width constraints */
            font-size: 0.9em;
            padding: 5px; /* Smaller padding for mobile */
            text-align: right !important; /* Force right justification on mobile */
        }
        .building-row input[id^="resource"] {
            width: 100%;
            max-width: unset; /* Remove desktop fixed width constraints */
            font-size: 0.9em;
            padding: 5px; /* Smaller padding for mobile */
            text-align: right !important; /* Force right justification on mobile */
        }
        .building-row label {
            font-size: 0.9em;
            padding: 0; /* Remove padding if not needed */
        }

        .header-row {
            /* Match building-row on mobile for perfect alignment */
            grid-template-columns: minmax(80px, 1fr) 40px 120px; /* Adjusted last column from 85px to 120px */
            gap: 8px;
            font-size: 0.9em; /* Match building row labels */
        }

        button {
            padding: 10px;
            font-size: 1em;
            margin-top: 15px;
        }

        .version-info {
            font-size: 0.65em; /* Slightly smaller for mobile */
            margin-top: 15px;
        }
    }
</style>
</head>
<body>

<div id="language-selector-container">
    <label for="languageSelect">Language:</label>
    <select id="languageSelect" tabindex="1">
        </select>
</div>

<div class="container">
    <h2 data-i18n="title">Time Until Optoelectronic Lab Can Be Upgraded</h2>

    <div class="header-row">
        <span></span>
        <strong id="header-level" data-i18n="headerLevel">Level</strong>
        <strong id="header-held" data-i18n="headerHeld">Held</strong>
    </div>

    <div class="building-row">
        <label id="building1-name" data-i18n="resourceBuilding1">Quartz Workshop 1</label>
        <input type="tel" id="level1" value="" onblur="updateCalculations(this); formatInput(this)" onfocus="this.select()" tabindex="2" aria-labelledby="building1-name header-level" maxlength="2">
        <input type="tel" id="resource1" value="" onblur="expandDecimal(this); updateCalculations(this); formatInput(this)" onfocus="this.select()" tabindex="7" aria-labelledby="building1-name header-held">
    </div>
    <div class="building-row">
        <label id="building2-name" data-i18n="resourceBuilding2">Quartz Workshop 2</label>
        <input type="tel" id="level2" value="" onblur="updateCalculations(this); formatInput(this)" onfocus="this.select()" tabindex="3" aria-labelledby="building2-name header-level" maxlength="2">
        <input type="tel" id="resource2" value="" onblur="expandDecimal(this); updateCalculations(this); formatInput(this)" onfocus="this.select()" tabindex="8" aria-labelledby="building2-name header-held">
    </div>
    <div class="building-row">
        <label id="building3-name" data-i18n="resourceBuilding3">Quartz Workshop 3</label>
        <input type="tel" id="level3" value="" onblur="updateCalculations(this); formatInput(this)" onfocus="this.select()" tabindex="4" aria-labelledby="building3-name header-level" maxlength="2">
        <input type="tel" id="resource3" value="" onblur="expandDecimal(this); updateCalculations(this); formatInput(this)" onfocus="this.select()" tabindex="9" aria-labelledby="building3-name header-held">
    </div>
    <div class="building-row">
        <label id="building4-name" data-i18n="resourceBuilding4">Quartz Workshop 4</label>
        <input type="tel" id="level4" value="" onblur="updateCalculations(this); formatInput(this)" onfocus="this.select()" tabindex="5" aria-labelledby="building4-name header-level" maxlength="2">
        <input type="tel" id="resource4" value="" onblur="expandDecimal(this); updateCalculations(this); formatInput(this)" onfocus="this.select()" tabindex="10" aria-labelledby="building4-name header-held">
    </div>
    <div class="building-row">
        <label id="weeklyBuilding-name" data-i18n="weeklyBuilding">Weekly Workshop</label>
        <input type="tel" id="levelWeekly" value="" onblur="updateCalculations(this); formatInput(this)" onfocus="this.select()" tabindex="6" aria-labelledby="weeklyBuilding-name header-level" maxlength="2">
        <input type="tel" id="resourceWeekly" value="" onblur="expandDecimal(this); updateCalculations(this); formatInput(this)" onfocus="this.select()" tabindex="11" aria-labelledby="weeklyBuilding-name header-held">
    </div>

    <hr>

    <div class="row">
        <span class="display-label" data-i18n="resourcePerHour">Quartz/hr:</span>
        <span id="resourceHrDisplay" class="display-value">0</span>
    </div>

    <div class="row">
        <label for="resourceHeldText" data-i18n="resourceHeld">Quartz Held:</label>
        <input type="tel" id="resourceHeldText" value="" onblur="expandDecimal(this); updateCalculations(this); formatInput(this)" onfocus="this.select()" tabindex="12">
    </div>

    <div class="row">
        <span class="display-label" data-i18n="totalResource">Total Quartz:</span>
        <span id="totalResourceDisplay" class="display-value">0</span>
    </div>

    <div class="row">
        <label for="resourceNeededText" data-i18n="resourceNeeded">Quartz Needed:</label>
        <input type="tel" id="resourceNeededText" value="" onblur="expandDecimal(this); updateCalculations(this); formatInput(this)" onfocus="this.select()" tabindex="13">
    </div>

    <div class="row">
        <span class="display-label" data-i18n="timeToComplete">Time to Complete:</span>
        <span id="timeDisplay" class="display-value">N/A</span>
    </div>

    <div class="row">
        <span class="display-label" data-i18n="completionTime">Completion Time:</span>
        <span id="completionTimeDisplay" class="display-value">N/A</span>
    </div>

    <div class="row">
        <label for="timezoneSelect" data-i18n="displayTimeZone">Display Time Zone:</label>
        <select id="timezoneSelect" onchange="updateCalculations()" tabindex="14">
            </select>
    </div>

    <button onclick="updateCalculations()" tabindex="15" data-i18n="calculateButton">Calculate</button>
</div>

<div class="version-info">
    Version 4.1.1 - Last Updated: June 12, 2025, 04:30 AM EDT
</div>

<script>
    // ######################### Configuration Variables #########################
    // Easily change these values to adapt the calculator for different buildings or resources
    const BUILDING_NAME = 'Optoelectronic Lab';
    const RESOURCE_NAME = 'Quartz'; // This constant defines the resource name and is NOT translated.
    const BUILDING_TYPE = 'Workshop'; // New variable for the type of building (e.g., Workshop, Factory, Field)
    // ###########################################################################

    // Define your translations
    const translations = {
        'en': { // English (default fallback)
            title: `Time Until ${BUILDING_NAME} Can Be Upgraded`,
            headerLevel: 'Level',
            headerHeld: 'Held',
            resourceBuilding1: `${RESOURCE_NAME} ${BUILDING_TYPE} 1`,
            resourceBuilding2: `${RESOURCE_NAME} ${BUILDING_TYPE} 2`,
            resourceBuilding3: `${RESOURCE_NAME} ${BUILDING_TYPE} 3`,
            resourceBuilding4: `${RESOURCE_NAME} ${BUILDING_TYPE} 4`,
            weeklyBuilding: `Weekly ${BUILDING_TYPE}`,
            resourcePerHour: `${RESOURCE_NAME}/hr:`,
            resourceHeld: `${RESOURCE_NAME} Held:`,
            totalResource: `Total ${RESOURCE_NAME}:`,
            resourceNeeded: `${RESOURCE_NAME} Needed:`,
            timeToComplete: 'Time to Complete:',
            completionTime: 'Completion Time:',
            displayTimeZone: 'Display Time Zone:',
            calculateButton: 'Calculate'
        },
        'es': { // Spanish
            title: `Tiempo hasta que el ${BUILDING_NAME} pueda ser mejorado`,
            headerLevel: 'Nivel',
            headerHeld: 'Obtenido',
            resourceBuilding1: `${RESOURCE_NAME} ${BUILDING_TYPE} 1`,
            resourceBuilding2: `${RESOURCE_NAME} ${BUILDING_TYPE} 2`,
            resourceBuilding3: `${RESOURCE_NAME} ${BUILDING_TYPE} 3`,
            resourceBuilding4: `${RESOURCE_NAME} ${BUILDING_TYPE} 4`,
            weeklyBuilding: `Semanal ${BUILDING_TYPE}`,
            resourcePerHour: `${RESOURCE_NAME}/hora:`,
            resourceHeld: `${RESOURCE_NAME} Actual:`,
            totalResource: `${RESOURCE_NAME} Total:`,
            resourceNeeded: `${RESOURCE_NAME} Necesario:`,
            timeToComplete: 'Tiempo Restante:',
            completionTime: 'Hora de Finalización:',
            displayTimeZone: 'Zona Horaria:',
            calculateButton: 'Calcular'
        },
        'pt': { // Portuguese
            title: `Tempo até o ${BUILDING_NAME} Poder Ser Atualizado`,
            headerLevel: 'Nível',
            headerHeld: 'Tido',
            resourceBuilding1: `${BUILDING_TYPE} de ${RESOURCE_NAME} 1`, // Portuguese word order
            resourceBuilding2: `${BUILDING_TYPE} de ${RESOURCE_NAME} 2`,
            resourceBuilding3: `${BUILDING_TYPE} de ${RESOURCE_NAME} 3`,
            resourceBuilding4: `${BUILDING_TYPE} de ${RESOURCE_NAME} 4`,
            weeklyBuilding: `${BUILDING_TYPE} Semanal`,
            resourcePerHour: `${RESOURCE_NAME}/hr:`,
            resourceHeld: `${RESOURCE_NAME} Atual:`,
            totalResource: `${RESOURCE_NAME} Total:`,
            resourceNeeded: `${RESOURCE_NAME} Necessário:`,
            timeToComplete: 'Tempo para Concluir:',
            completionTime: 'Hora de Conclusão:',
            displayTimeZone: 'Fuso Horário:',
            calculateButton: 'Calcular'
        },
        'ko': { // Korean
            title: `${BUILDING_NAME} 업그레이드까지 남은 시간`,
            headerLevel: '레벨',
            headerHeld: '보유',
            resourceBuilding1: `${RESOURCE_NAME} ${BUILDING_TYPE} 1`,
            resourceBuilding2: `${RESOURCE_NAME} ${BUILDING_TYPE} 2`,
            resourceBuilding3: `${RESOURCE_NAME} ${BUILDING_TYPE} 3`,
            resourceBuilding4: `${RESOURCE_NAME} ${BUILDING_TYPE} 4`,
            weeklyBuilding: `주간 ${BUILDING_TYPE}`,
            resourcePerHour: `시간당 ${RESOURCE_NAME}:`,
            resourceHeld: `보유 ${RESOURCE_NAME}:`,
            totalResource: `총 ${RESOURCE_NAME}:`,
            resourceNeeded: `필요한 ${RESOURCE_NAME}:`,
            timeToComplete: '완료까지 남은 시간:',
            completionTime: '완료 시간:',
            displayTimeZone: '표시 시간대:',
            calculateButton: '계산'
        },
        'ja': { // Japanese
            title: `${BUILDING_NAME} アップグレードまでの時間`,
            headerLevel: 'レベル',
            headerHeld: '所持',
            resourceBuilding1: `${RESOURCE_NAME} ${BUILDING_TYPE} 1`, // Added space for consistency and readability
            resourceBuilding2: `${RESOURCE_NAME} ${BUILDING_TYPE} 2`,
            resourceBuilding3: `${RESOURCE_NAME} ${BUILDING_TYPE} 3`,
            resourceBuilding4: `${RESOURCE_NAME} ${BUILDING_TYPE} 4`,
            weeklyBuilding: `週次 ${BUILDING_TYPE}`, // Added space
            resourcePerHour: `${RESOURCE_NAME}/時:`,
            resourceHeld: `所持${RESOURCE_NAME}:`, // No space here as per common Japanese
            totalResource: `合計${RESOURCE_NAME}:`, // No space here
            resourceNeeded: `必要な${RESOURCE_NAME}:`, // No space here
            timeToComplete: '完了までの時間:',
            completionTime: '完了時刻:',
            displayTimeZone: '表示タイムゾーン:',
            calculateButton: '計算'
        }
    };

    // Function to apply translations based on a specified language or auto-detect
    function applyTranslations(langOverride = null) {
        let langToUse;

        if (langOverride) {
            langToUse = langOverride;
        } else if (document.getElementById('languageSelect') && document.getElementById('languageSelect').value) {
            langToUse = document.getElementById('languageSelect').value;
        } else {
            langToUse = navigator.language.split('-')[0];
        }

        // Ensure the language code exists in our translations, fallback to 'en'
        const currentTranslations = translations[langToUse] || translations['en'];

        const languageSelect = document.getElementById('languageSelect');
        if (languageSelect && languageSelect.value !== langToUse) {
            languageSelect.value = langToUse;
        }

        document.querySelectorAll('[data-i18n]').forEach(element => {
            const key = element.getAttribute('data-i18n');
            if (currentTranslations[key]) {
                // If the element is the title tag, update document.title
                if (element.tagName.toLowerCase() === 'title') {
                    document.title = currentTranslations[key];
                } else {
                    element.textContent = currentTranslations[key];
                }
            }
        });

        // Ensure the h2 element is updated (it also has data-i18n="title")
        // This is a redundant but safe way to ensure the main title is updated.
        const h2Element = document.querySelector('h2[data-i18n="title"]');
        if (h2Element && currentTranslations.title) {
            h2Element.textContent = currentTranslations.title;
        }

        const buttonElement = document.querySelector('button');
        if (buttonElement && currentTranslations.calculateButton) {
            buttonElement.textContent = currentTranslations.calculateButton;
        }
    }

    // Function to populate the language selection dropdown
    function populateLanguageSelector() {
        const languageSelect = document.getElementById('languageSelect');
        languageSelect.innerHTML = '';

        const languageNames = {
            'en': 'English',
            'es': 'Español',
            'pt': 'Português',
            'ko': '한국어',
            'ja': '日本語'
        };

        for (const langCode in translations) {
            if (translations.hasOwnProperty(langCode)) {
                const option = document.createElement('option');
                option.value = langCode;
                option.textContent = languageNames[langCode] || langCode;
                languageSelect.appendChild(option);
            }
        }

        const userBrowserLang = navigator.language.split('-')[0];
        if (languageSelect.querySelector(`option[value="${userBrowserLang}"]`)) {
            languageSelect.value = userBrowserLang;
        } else {
            languageSelect.value = 'en';
        }

        languageSelect.addEventListener('change', (event) => {
            applyTranslations(event.target.value);
            updateCalculations();
        });
    }

    // ######################### Helper Functions #########################
    const MAX_ALLOWED_RESOURCE = 99999999999; // Cap at 99 Billion

    /**
     * Expands a decimal number like 6.8 to 6800 for 'resource' input fields.
     * Modifies the inputElement.value directly.
     */
    function expandDecimal(inputElement) {
        // Only apply to resource inputs (resource1-4, resourceWeekly, resourceHeldText, resourceNeededText)
        if (!inputElement.id.startsWith('resource')) {
            return;
        }

        let value = inputElement.value.replace(/,/g, ''); // Remove commas for parsing
        const parsed = parseFloat(value);

        // Check if it's a number, contains a decimal, and has a fractional part (e.g., 6.0 is not 6.000)
        if (!isNaN(parsed) && value.includes('.') && parsed % 1 !== 0) {
            inputElement.value = Math.round(parsed * 1000).toString();
        }
    }

    /**
     * Formats a number input with thousands separators and applies max value cap.
     */
    function formatInput(inputElement) {
        let value = inputElement.value.replace(/[^0-9.]/g, ''); // Remove non-numeric except dot
        if (value === '') {
            inputElement.value = '';
            return;
        }
        let number = parseFloat(value);
        if (isNaN(number)) {
            inputElement.value = '';
            return;
        }

        // Apply max value cap
        if (number > MAX_ALLOWED_RESOURCE) {
            number = MAX_ALLOWED_RESOURCE;
            // Update the actual input value if it was truncated
            // We'll let toLocaleString format it for display
            inputElement.value = number.toString();
        }

        // Determine if it should display decimals.
        if (number % 1 === 0) { // It's a whole number
            inputElement.value = number.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        } else { // It has a fractional part
            inputElement.value = number.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 2 }); // Allow up to 2 decimals for display
        }
    }

    // Function to get a cleaned number from a textbox (removes commas)
    // This function now assumes expandDecimal has already transformed the value if necessary,
    // and formatInput has applied the MAX_ALLOWED_RESOURCE cap.
    function getCleanNumber(id) {
        const inputElement = document.getElementById(id);
        if (!inputElement) return 0;
        const value = inputElement.value.replace(/,/g, ''); // Remove commas for calculation
        return parseFloat(value) || 0;
    }

    // ######################### Time Zone Logic #########################

    const curatedTimeZoneIds = [
        "Etc/UTC",
        "America/St_Johns",
        "America/Halifax",
        "America/New_York",
        "America/Indiana/Indianapolis",
        "America/Chicago",
        "America/Denver",
        "America/Phoenix",
        "America/Los_Angeles",
        "America/Anchorage",
        "America/Honolulu",
        "Asia/Tokyo"
    ];

    function getNumericalOffsetInHours(tzId) {
        try {
            const now = new Date();
            // Using 'en-US' locale to get a consistent offset string format.
            const offsetFormatter = new Intl.DateTimeFormat('en-US', {
                timeZone: tzId,
                timeZoneName: 'shortOffset', // e.g., "GMT-04:00"
            });
            const offsetString = offsetFormatter.format(now);

            // Directly parse the timezone offset from the full offset string (e.g., "GMT-04:00")
            const utcMatch = offsetString.match(/(GMT|UTC)([+-]\d{1,2}(:\d{2})?)/);
            if (utcMatch && utcMatch[2]) {
                const offsetPart = utcMatch[2];
                const sign = offsetPart.startsWith('-') ? -1 : 1;
                const [hoursStr, minutesStr] = offsetPart.replace(/[+-]/, '').split(':');
                let totalHours = parseInt(hoursStr, 10);
                if (minutesStr) {
                    totalHours += parseInt(minutesStr, 10) / 60;
                }
                return sign * totalHours;
            }

            // Fallback for time zones without a clear GMT/UTC offset string (like 'EST', 'PST' which format as just 'EST' or 'PST')
            // Calculate offset based on current date's difference from UTC
            // This is less robust but might be necessary for some browser/locale combinations.
            const tzDate = new Date(now.toLocaleString('en-US', { timeZone: tzId }));
            const utcDate = new Date(now.toUTCString());
            const diffMs = tzDate.getTime() - utcDate.getTime();
            return diffMs / (1000 * 60 * 60); // Convert milliseconds to hours

        } catch (e) {
            console.error(`Error calculating offset for '${tzId}':`, e);
        }
        return 0; // Default to UTC if any error
    }

    function populateTimezones() {
        const timezoneSelect = document.getElementById('timezoneSelect');
        const now = new Date();
        const localTimeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;

        timezoneSelect.innerHTML = '';

        const tempOptions = [];

        curatedTimeZoneIds.forEach(tzId => {
            let offsetHours = 0;
            let longTimeZoneName = tzId;
            let formattedOffset = `UTC+0`;

            try {
                // Validate if timeZone ID is supported by browser
                new Intl.DateTimeFormat('en-US', { timeZone: tzId }).format(now);

                offsetHours = getNumericalOffsetInHours(tzId);

                if (offsetHours === 0) {
                    formattedOffset = `UTC+0`;
                } else {
                    const offsetSign = offsetHours > 0 ? '+' : '-';
                    const absOffsetHours = Math.abs(offsetHours);
                    const integerHours = Math.floor(absOffsetHours);
                    const fractionalMinutes = Math.round((absOffsetHours % 1) * 60); // Round to avoid 59.9999

                    if (fractionalMinutes > 0) {
                        formattedOffset = `UTC${offsetSign}${integerHours.toString().padStart(2, '0')}:${fractionalMinutes.toString().padStart(2, '0')}`;
                    } else {
                        formattedOffset = `UTC${offsetSign}${integerHours.toString().padStart(2, '0')}`;
                    }
                }

                // Get display name, preferring long name if available and not empty
                const parts = new Intl.DateTimeFormat('en-US', {
                    timeZone: tzId,
                    timeZoneName: 'long',
                    year: 'numeric', month: 'numeric', day: 'numeric', // Required for timeZoneName to be reliable in some browsers
                    hour: 'numeric', minute: 'numeric', second: 'numeric'
                }).formatToParts(now);

                let foundTimeZoneNamePart = parts.find(part => part.type === 'timeZoneName');
                if (foundTimeZoneNamePart && typeof foundTimeZoneNamePart.value === 'string' && foundTimeZoneNamePart.value.trim() !== '') {
                    longTimeZoneName = foundTimeZoneNamePart.value;
                } else {
                    // Fallback to specific names if browser name is generic or missing
                    if (tzId === "America/Phoenix") {
                        longTimeZoneName = "Arizona (Mountain)";
                    } else if (tzId === "America/Indiana/Indianapolis") {
                        longTimeZoneName = "Indiana (East)";
                    } else if (tzId === "Etc/UTC") {
                        longTimeZoneName = "Coordinated Universal Time";
                    } else {
                        longTimeZoneName = tzId.replace(/_/g, ' ').replace('America/', ''); // Clean up ID
                    }
                }
            } catch (e) {
                console.warn(`Time zone '${tzId}' unsupported by browser or error occurred. Using static fallback.`, e.message);
                // Static fallbacks for explicitly unsupported or problematic IDs
                if (tzId === "America/Honolulu") {
                    longTimeZoneName = "Hawaii";
                    formattedOffset = "UTC-10:00";
                    offsetHours = -10;
                } else if (tzId === "Etc/UTC") {
                    longTimeZoneName = "Coordinated Universal Time";
                    formattedOffset = "UTC+0";
                    offsetHours = 0;
                } else {
                    longTimeZoneName = `${tzId} (Unsupported)`;
                    formattedOffset = `UTC+0`;
                    offsetHours = 0;
                }
            }

            tempOptions.push({
                id: tzId,
                name: `${longTimeZoneName} (${formattedOffset})`,
                offset: offsetHours
            });
        });

        tempOptions.sort((a, b) => {
            if (a.offset !== b.offset) {
                return a.offset - b.offset;
            }
            return a.name.localeCompare(b.name);
        });

        tempOptions.forEach(tzData => {
            const option = document.createElement('option');
            option.value = tzData.id;
            option.textContent = tzData.name;
            timezoneSelect.appendChild(option);
        });

        // Set default to local time zone, or closest match if not in curated list
        timezoneSelect.value = localTimeZone;
        if (timezoneSelect.value !== localTimeZone && tempOptions.length > 0) {
            const localOffset = getNumericalOffsetInHours(localTimeZone);
            let bestMatchIndex = 0;
            let minDiff = Infinity;

            for (let i = 0; i < tempOptions.length; i++) {
                const diff = Math.abs(tempOptions[i].offset - localOffset);
                if (diff < minDiff) {
                    minDiff = diff;
                    bestMatchIndex = i;
                }
            }
            timezoneSelect.selectedIndex = bestMatchIndex;
            console.log(`Local timezone '${localTimeZone}' not directly in curated list. Defaulting to closest offset: '${tempOptions[bestMatchIndex].name}'.`);
        }
    }


    // ######################### Main Calculation Logic #########################
    /**
     * Performs calculations and handles auto-population of resource held values.
     * @param {HTMLElement} [triggeringElement=null] - The input element that triggered the update (e.g., onblur).
     */
    function updateCalculations(triggeringElement = null) {
        let totalResourcesFromBuildings = 0;
        let totalBuildingRate = 0;

        const buildingLevels = [
            document.getElementById('level1'),
            document.getElementById('level2'),
            document.getElementById('level3'),
            document.getElementById('level4'),
            document.getElementById('levelWeekly')
        ];
        const resourceBuildings = [
            document.getElementById('resource1'),
            document.getElementById('resource2'),
            document.getElementById('resource3'),
            document.getElementById('resource4'),
            document.getElementById('resourceWeekly')
        ];

        // --- Auto-population Logic ---
        // Only trigger auto-population if a 'resource' input was the triggering element
        if (triggeringElement && triggeringElement.id.startsWith('resource')) {
            const triggeredLevelId = 'level' + triggeringElement.id.replace('resource', '');
            const triggeredLevelElement = document.getElementById(triggeredLevelId);
            const triggeredLevel = getCleanNumber(triggeredLevelId);
            const triggeredResourceValue = getCleanNumber(triggeringElement.id);

            // Only auto-populate if source level is valid (greater than 0) and resource value is also valid
            if (triggeredLevel > 0 && triggeredResourceValue > 0) {
                for (let i = 0; i < resourceBuildings.length; i++) {
                    const currentResourceElement = resourceBuildings[i];
                    const currentLevelElement = buildingLevels[i];

                    // Don't auto-populate the element that just triggered the update
                    if (currentResourceElement.id === triggeringElement.id) {
                        continue;
                    }

                    const currentLevel = getCleanNumber(currentLevelElement.id);
                    const currentResourceValue = getCleanNumber(currentResourceElement.id);

                    // Auto-populate if levels match AND (target field is empty OR target field has the same value as source)
                    // The "same value as source" check allows subsequent auto-fills to overwrite
                    // previous auto-fills, but not manually changed values.
                    if (currentLevel > 0 && currentLevel === triggeredLevel &&
                        (currentResourceValue === 0 || currentResourceValue === triggeredResourceValue)) {

                        currentResourceElement.value = triggeredResourceValue.toString(); // Set the raw value
                        formatInput(currentResourceElement); // Immediately format the auto-populated field
                    }
                }
            }
        }
        // --- End Auto-population Logic ---

        // --- Standard Calculations ---
        for (let i = 0; i < 5; i++) {
            let level = getCleanNumber(buildingLevels[i].id);
            if (level <= 30) { // Only levels up to 30 contribute to rate
                totalBuildingRate += level;
            }
            let resource = getCleanNumber(resourceBuildings[i].id);
            totalResourcesFromBuildings += resource;
        }

        const resourceHeld = getCleanNumber('resourceHeldText');
        const resourceNeeded = getCleanNumber('resourceNeededText');

        const resourcePerHour = totalBuildingRate * 720;
        document.getElementById('resourceHrDisplay').textContent = resourcePerHour.toLocaleString('en-US');

        const totalCurrentResource = resourceHeld + totalResourcesFromBuildings;
        document.getElementById('totalResourceDisplay').textContent = totalCurrentResource.toLocaleString('en-US');

        const timeDisplay = document.getElementById('timeDisplay');
        const completionTimeDisplay = document.getElementById('completionTimeDisplay');

        if (resourcePerHour > 0 && totalCurrentResource < resourceNeeded) {
            const hoursRequired = (resourceNeeded - totalCurrentResource) / resourcePerHour;
            timeDisplay.textContent = `${hoursRequired.toFixed(2)} hrs`;

            const completionDateTimeUtc = new Date(Date.now() + hoursRequired * 60 * 60 * 1000);

            const selectedTimeZone = document.getElementById('timezoneSelect').value;

            if (!selectedTimeZone) {
                console.error("No time zone selected in dropdown. Cannot display completion time.");
                completionTimeDisplay.textContent = "N/A (Select TZ)";
                return;
            }

            try {
                const formatter = new Intl.DateTimeFormat('en-US', {
                    hour: 'numeric',
                    minute: 'numeric',
                    hour12: true,
                    timeZone: selectedTimeZone,
                    timeZoneName: 'short'
                });
                completionTimeDisplay.textContent = formatter.format(completionDateTimeUtc);
            } catch (e) {
                console.error(`Error formatting completion time for '${selectedTimeZone}'. Displaying UTC.`, e);
                const utcFormatter = new Intl.DateTimeFormat('en-US', {
                    hour: 'numeric',
                    minute: 'numeric',
                    hour12: true,
                    timeZone: 'UTC',
                    timeZoneName: 'short'
                });
                completionTimeDisplay.textContent = `UTC: ${utcFormatter.format(completionDateTimeUtc)}`;
            }

        } else {
            timeDisplay.textContent = "N/A";
            completionTimeDisplay.textContent = "N/A";
        }
        // --- End Standard Calculations ---

        // Re-format the main resourceHeldText and resourceNeededText after calculations,
        // as they are not part of the auto-population loop for buildings.
        // Building resource fields are formatted within the auto-population loop or by their own onblur handler.
        if (document.getElementById('resourceHeldText').value !== '') formatInput(document.getElementById('resourceHeldText'));
        if (document.getElementById('resourceNeededText').value !== '') formatInput(document.getElementById('resourceNeededText'));
        // Re-format level fields if the triggering element was a level input
        if (triggeringElement && triggeringElement.id.startsWith('level') && triggeringElement.value !== '') {
            formatInput(triggeringElement);
        }
    }

    // ######################### Initial Load #########################
    window.onload = () => {
        populateLanguageSelector();
        populateTimezones();
        applyTranslations(); // Initial translation application, including for title
        updateCalculations(); // Initial calculation and display update
    };
</script>

</body>
</html>
